// ==UserScript==
// @name         ipoke-auto-refresh+notice+push
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  try to take over the world!
// @author       Rplus
// @match        https://twpkinfo.com/ipoke.aspx*
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==


(function() {
window.log = [{ data: '[]', time: new Date()}];
let notiUrl = GM_getValue('notiUrl') || '';
let DesiredList = GM_getValue('list');
if (!DesiredList) {
  DesiredList = [
    '/IV100/',
    // '/443.',
    // '/444.',
    '/524.',
    '/525.',
    '/564.',
    '/566.',
    '/610.',
    '/611.',
    '/633.',
    '/634.',
  ];
}

// click-event
let refreshTimer;
const refreshInterval = 1;
const msInMin = 60 * 1000;
const refreshBtn = $('#update');
refreshBtn.addEventListener('click', () => {
  console.log('click');
  refreshLoop();

  // checkLater
  setTimeout(searching, 5000);
  // setTimeout(sentNotice, 7000);
});

function searching() {
  console.log('searching');
  let imgs = findDesiredImgs();
  if (!imgs) { return; }

  let _data = genInfo(imgs);
  let newLog = JSON.stringify(_data);
  console.log(imgs, _data, newLog);

  let oldLog = window.log[0].data;
  let oldData = JSON.parse(oldLog);

  if (newLog === oldLog) { return; }

  window.log.unshift({
    data: newLog,
    time: new Date(),
  });

  // compare, remove old data
  let newData = _data.filter(i => oldData.indexOf(i) === -1);
  if (!newData.length) { return; }

  sentNotice(newData);
}

function genInfo(imgs) {
  return imgs.map(i => {
    let str = i.src.match(/([^/]+)\.png$/)[1];
    let pos = getPos(i);
    let dex = str.split('_')[0].padStart(3, '0');
    let name = names[dex] || dex;
    return [name, i.src.match(/([^/]+)\.png$/)[1], pos].join(', ');
  });
}

function sentNotice(notice) {
  // // keep log smaller
  // window.log = window.log.slice(-20);

  console.log(notice);

  let n = new Notification('', { body: notice.join('\n') });
  n.onshow = setTimeout(() => { n.close();}, 5000);
  n.onclick = () => {
    window.focus();
    n.close();
  };

  let url = notiUrl.replace('%s', notice.join('%0A'));

  console.log(url);
  // fetch(url);
}


// loop-timer
function refreshLoop() {
  // console.log('refreshLoop');
  if (refreshTimer) {
    window.clearTimeout(refreshTimer);
    refreshTimer = null;
  }
  refreshTimer = setTimeout(fetchNewData, refreshInterval * msInMin);
}

function fetchNewData() {
  // console.log('fetchNewData');
  refreshBtn.click();
}

// notice

// helper
function isElementInViewport(el) {
  var rect = el.getBoundingClientRect();
  return (
    rect.top >= 0 &&
    rect.left >= 0 &&
    rect.bottom <= (window.innerHeight || document. documentElement.clientHeight) &&
    rect.right <= (window.innerWidth || document. documentElement.clientWidth)
  );
}

// query images
function getImgsInView() {
  return [
    ...document.querySelectorAll(`
      img.leaflet-marker-icon,
      img.poke_divIcon45_img,
      div[class^="poke_divIcon45_iv_90"]
    `)
  ]
  .filter(img => isElementInViewport(img));
}

function findDesiredImgs(imgs = getImgsInView()) {
  imgs = imgs
    .filter(i => i.src)
    .filter(i => DesiredList.some(p => i.src.indexOf(p) !== -1));

  return imgs || false;
}

function getPos(target) {
  let tRect = target.getBoundingClientRect();
  let c = $('img.leaflet-marker-icon') && $('img.leaflet-marker-icon').getBoundingClientRect();
  let bRect = $('#map').getBoundingClientRect();
  let bWh = bRect.width / 2;
  let bHh = bRect.height / 2;
  let cPos = c
    ? { x: c.x, y: c.y }
    : { x: bRect.x + bWh, y: bRect.y + bHh }

  let pos = {
    x: ((tRect.x - cPos.x) / bRect.width).toFixed(3),
    y: ((tRect.y - cPos.y) / -bRect.height).toFixed(3),
  };

  return `(${pos.x}, ${pos.y})`;
}

function $(selector) {
  return document.querySelector(selector);
}

let names = {
  "001": "妙蛙種子",
  "002": "妙蛙草",
  "003": "妙蛙花",
  "004": "小火龍",
  "005": "火恐龍",
  "006": "噴火龍",
  "007": "傑尼龜",
  "008": "卡咪龜",
  "009": "水箭龜",
  "010": "綠毛蟲",
  "011": "鐵甲蛹",
  "012": "巴大蝶",
  "013": "獨角蟲",
  "014": "鐵殼蛹",
  "015": "大針蜂",
  "016": "波波",
  "017": "比比鳥",
  "018": "大比鳥",
  "019": "小拉達",
  "020": "拉達",
  "021": "烈雀",
  "022": "大嘴雀",
  "023": "阿柏蛇",
  "024": "阿柏怪",
  "025": "皮卡丘",
  "026": "雷丘",
  "027": "穿山鼠",
  "028": "穿山王",
  "029": "尼多蘭",
  "030": "尼多娜",
  "031": "尼多后",
  "032": "尼多朗",
  "033": "尼多力諾",
  "034": "尼多王",
  "035": "皮皮",
  "036": "皮可西",
  "037": "六尾",
  "038": "九尾",
  "039": "胖丁",
  "040": "胖可丁",
  "041": "超音蝠",
  "042": "大嘴蝠",
  "043": "走路草",
  "044": "臭臭花",
  "045": "霸王花",
  "046": "派拉斯",
  "047": "派拉斯特",
  "048": "毛球",
  "049": "摩魯蛾",
  "050": "地鼠",
  "051": "三地鼠",
  "052": "喵喵",
  "053": "貓老大",
  "054": "可達鴨",
  "055": "哥達鴨",
  "056": "猴怪",
  "057": "火爆猴",
  "058": "卡蒂狗",
  "059": "風速狗",
  "060": "蚊香蝌蚪",
  "061": "蚊香君",
  "062": "蚊香泳士",
  "063": "凱西",
  "064": "勇基拉",
  "065": "胡地",
  "066": "腕力",
  "067": "豪力",
  "068": "怪力",
  "069": "喇叭芽",
  "070": "口呆花",
  "071": "大食花",
  "072": "瑪瑙水母",
  "073": "毒刺水母",
  "074": "小拳石",
  "075": "隆隆石",
  "076": "隆隆岩",
  "077": "小火馬",
  "078": "烈焰馬",
  "079": "呆呆獸",
  "080": "呆殼獸",
  "081": "小磁怪",
  "082": "三合一磁怪",
  "083": "大蔥鴨",
  "084": "嘟嘟",
  "085": "嘟嘟利",
  "086": "小海獅",
  "087": "白海獅",
  "088": "臭泥",
  "089": "臭臭泥",
  "090": "大舌貝",
  "091": "刺甲貝",
  "092": "鬼斯",
  "093": "鬼斯通",
  "094": "耿鬼",
  "095": "大岩蛇",
  "096": "催眠貘",
  "097": "引夢貘人",
  "098": "大鉗蟹",
  "099": "巨鉗蟹",
  "100": "霹靂電球",
  "101": "頑皮雷彈",
  "102": "蛋蛋",
  "103": "椰蛋樹",
  "104": "卡拉卡拉",
  "105": "嘎啦嘎啦",
  "106": "飛腿郎",
  "107": "快拳郎",
  "108": "大舌頭",
  "109": "瓦斯彈",
  "110": "雙彈瓦斯",
  "111": "獨角犀牛",
  "112": "鑽角犀獸",
  "113": "吉利蛋",
  "114": "蔓藤怪",
  "115": "袋獸",
  "116": "墨海馬",
  "117": "海刺龍",
  "118": "角金魚",
  "119": "金魚王",
  "120": "海星星",
  "121": "寶石海星",
  "122": "魔牆人偶",
  "123": "飛天螳螂",
  "124": "迷唇姐",
  "125": "電擊獸",
  "126": "鴨嘴火獸",
  "127": "凱羅斯",
  "128": "肯泰羅",
  "129": "鯉魚王",
  "130": "暴鯉龍",
  "131": "拉普拉斯",
  "132": "百變怪",
  "133": "伊布",
  "134": "水伊布",
  "135": "雷伊布",
  "136": "火伊布",
  "137": "多邊獸",
  "138": "菊石獸",
  "139": "多刺菊石獸",
  "140": "化石盔",
  "141": "鐮刀盔",
  "142": "化石翼龍",
  "143": "卡比獸",
  "144": "急凍鳥",
  "145": "閃電鳥",
  "146": "火焰鳥",
  "147": "迷你龍",
  "148": "哈克龍",
  "149": "快龍",
  "150": "超夢",
  "151": "夢幻",
  "152": "菊草葉",
  "153": "月桂葉",
  "154": "大竺葵",
  "155": "火球鼠",
  "156": "火岩鼠",
  "157": "火爆獸",
  "158": "小鋸鱷",
  "159": "藍鱷",
  "160": "大力鱷",
  "161": "尾立",
  "162": "大尾立",
  "163": "咕咕",
  "164": "貓頭夜鷹",
  "165": "芭瓢蟲",
  "166": "安瓢蟲",
  "167": "圓絲蛛",
  "168": "阿利多斯",
  "169": "叉字蝠",
  "170": "燈籠魚",
  "171": "電燈怪",
  "172": "皮丘",
  "173": "皮寶寶",
  "174": "寶寶丁",
  "175": "波克比",
  "176": "波克基古",
  "177": "天然雀",
  "178": "天然鳥",
  "179": "咩利羊",
  "180": "茸茸羊",
  "181": "電龍",
  "182": "美麗花",
  "183": "瑪力露",
  "184": "瑪力露麗",
  "185": "樹才怪",
  "186": "蚊香蛙皇",
  "187": "毽子草",
  "188": "毽子花",
  "189": "毽子棉",
  "190": "長尾怪手",
  "191": "向日種子",
  "192": "向日花怪",
  "193": "蜻蜻蜓",
  "194": "烏波",
  "195": "沼王",
  "196": "太陽伊布",
  "197": "月亮伊布",
  "198": "黑暗鴉",
  "199": "呆呆王",
  "200": "夢妖",
  "201": "未知圖騰",
  "202": "果然翁",
  "203": "麒麟奇",
  "204": "榛果球",
  "205": "佛烈托斯",
  "206": "土龍弟弟",
  "207": "天蠍",
  "208": "大鋼蛇",
  "209": "布魯",
  "210": "布魯皇",
  "211": "千針魚",
  "212": "巨鉗螳螂",
  "213": "壺壺",
  "214": "赫拉克羅斯",
  "215": "狃拉",
  "216": "熊寶寶",
  "217": "圈圈熊",
  "218": "熔岩蟲",
  "219": "熔岩蝸牛",
  "220": "小山豬",
  "221": "長毛豬",
  "222": "太陽珊瑚",
  "223": "鐵炮魚",
  "224": "章魚桶",
  "225": "信使鳥",
  "226": "巨翅飛魚",
  "227": "盔甲鳥",
  "228": "戴魯比",
  "229": "黑魯加",
  "230": "刺龍王",
  "231": "小小象",
  "232": "頓甲",
  "233": "多邊獸Ⅱ",
  "234": "驚角鹿",
  "235": "圖圖犬",
  "236": "無畏小子",
  "237": "戰舞郎",
  "238": "迷唇娃",
  "239": "電擊怪",
  "240": "鴨嘴寶寶",
  "241": "大奶罐",
  "242": "幸福蛋",
  "243": "雷公",
  "244": "炎帝",
  "245": "水君",
  "246": "幼基拉斯",
  "247": "沙基拉斯",
  "248": "班基拉斯",
  "249": "洛奇亞",
  "250": "鳳王",
  "251": "時拉比",
  "252": "木守宮",
  "253": "森林蜥蜴",
  "254": "蜥蜴王",
  "255": "火稚雞",
  "256": "力壯雞",
  "257": "火焰雞",
  "258": "水躍魚",
  "259": "沼躍魚",
  "260": "巨沼怪",
  "261": "土狼犬",
  "262": "大狼犬",
  "263": "蛇紋熊",
  "264": "直衝熊",
  "265": "刺尾蟲",
  "266": "甲殼繭",
  "267": "狩獵鳳蝶",
  "268": "盾甲繭",
  "269": "毒粉蛾",
  "270": "蓮葉童子",
  "271": "蓮帽小童",
  "272": "樂天河童",
  "273": "橡實果",
  "274": "長鼻葉",
  "275": "狡猾天狗",
  "276": "傲骨燕",
  "277": "大王燕",
  "278": "長翅鷗",
  "279": "大嘴鷗",
  "280": "拉魯拉絲",
  "281": "奇魯莉安",
  "282": "沙奈朵",
  "283": "溜溜糖球",
  "284": "雨翅蛾",
  "285": "蘑蘑菇",
  "286": "斗笠菇",
  "287": "懶人獺",
  "288": "過動猿",
  "289": "請假王",
  "290": "土居忍士",
  "291": "鐵面忍者",
  "292": "脫殼忍者",
  "293": "咕妞妞",
  "294": "吼爆彈",
  "295": "爆音怪",
  "296": "幕下力士",
  "297": "鐵掌力士",
  "298": "露力麗",
  "299": "朝北鼻",
  "300": "向尾喵",
  "301": "優雅貓",
  "302": "勾魂眼",
  "303": "大嘴娃",
  "304": "可可多拉",
  "305": "可多拉",
  "306": "波士可多拉",
  "307": "瑪沙那",
  "308": "恰雷姆",
  "309": "落雷獸",
  "310": "雷電獸",
  "311": "正電拍拍",
  "312": "負電拍拍",
  "313": "電螢蟲",
  "314": "甜甜螢",
  "315": "毒薔薇",
  "316": "溶食獸",
  "317": "吞食獸",
  "318": "利牙魚",
  "319": "巨牙鯊",
  "320": "吼吼鯨",
  "321": "吼鯨王",
  "322": "呆火駝",
  "323": "噴火駝",
  "324": "煤炭龜",
  "325": "跳跳豬",
  "326": "噗噗豬",
  "327": "晃晃斑",
  "328": "大顎蟻",
  "329": "超音波幼蟲",
  "330": "沙漠蜻蜓",
  "331": "刺球仙人掌",
  "332": "夢歌仙人掌",
  "333": "青綿鳥",
  "334": "七夕青鳥",
  "335": "貓鼬斬",
  "336": "飯匙蛇",
  "337": "月石",
  "338": "太陽岩",
  "339": "泥泥鰍",
  "340": "鯰魚王",
  "341": "龍蝦小兵",
  "342": "鐵螯龍蝦",
  "343": "天秤偶",
  "344": "念力土偶",
  "345": "觸手百合",
  "346": "搖籃百合",
  "347": "太古羽蟲",
  "348": "太古盔甲",
  "349": "醜醜魚",
  "350": "美納斯",
  "351": "飄浮泡泡",
  "352": "變隱龍",
  "353": "怨影娃娃",
  "354": "詛咒娃娃",
  "355": "夜巡靈",
  "356": "彷徨夜靈",
  "357": "熱帶龍",
  "358": "風鈴鈴",
  "359": "阿勃梭魯",
  "360": "小果然",
  "361": "雪童子",
  "362": "冰鬼護",
  "363": "海豹球",
  "364": "海魔獅",
  "365": "帝牙海獅",
  "366": "珍珠貝",
  "367": "獵斑魚",
  "368": "櫻花魚",
  "369": "古空棘魚",
  "370": "愛心魚",
  "371": "寶貝龍",
  "372": "甲殼龍",
  "373": "暴飛龍",
  "374": "鐵啞鈴",
  "375": "金屬怪",
  "376": "巨金怪",
  "377": "雷吉洛克",
  "378": "雷吉艾斯",
  "379": "雷吉斯奇魯",
  "380": "拉帝亞斯",
  "381": "拉帝歐斯",
  "382": "蓋歐卡",
  "383": "固拉多",
  "384": "烈空坐",
  "385": "基拉祈",
  "386": "代歐奇希斯",
  "387": "草苗龜",
  "388": "樹林龜",
  "389": "土台龜",
  "390": "小火焰猴",
  "391": "猛火猴",
  "392": "烈焰猴",
  "393": "波加曼",
  "394": "波皇子",
  "395": "帝王拿波",
  "396": "姆克兒",
  "397": "姆克鳥",
  "398": "姆克鷹",
  "399": "大牙狸",
  "400": "大尾狸",
  "401": "圓法師",
  "402": "音箱蟀",
  "403": "小貓怪",
  "404": "勒克貓",
  "405": "倫琴貓",
  "406": "含羞苞",
  "407": "羅絲雷朵",
  "408": "頭蓋龍",
  "409": "戰槌龍",
  "410": "盾甲龍",
  "411": "護城龍",
  "412": "結草兒",
  "413": "結草貴婦",
  "414": "紳士蛾",
  "415": "三蜜蜂",
  "416": "蜂女王",
  "417": "帕奇利茲",
  "418": "泳圈鼬",
  "419": "浮潛鼬",
  "420": "櫻花寶",
  "421": "櫻花兒",
  "422": "無殼海兔",
  "423": "海兔獸",
  "424": "雙尾怪手",
  "425": "飄飄球",
  "426": "隨風球",
  "427": "捲捲耳",
  "428": "長耳兔",
  "429": "夢妖魔",
  "430": "烏鴉頭頭",
  "431": "魅力喵",
  "432": "東施喵",
  "433": "鈴鐺響",
  "434": "臭鼬噗",
  "435": "坦克臭鼬",
  "436": "銅鏡怪",
  "437": "青銅鐘",
  "438": "盆才怪",
  "439": "魔尼尼",
  "440": "小福蛋",
  "441": "聒噪鳥",
  "442": "花岩怪",
  "443": "圓陸鯊",
  "444": "尖牙陸鯊",
  "445": "烈咬陸鯊",
  "446": "小卡比獸",
  "447": "利歐路",
  "448": "路卡利歐",
  "449": "沙河馬",
  "450": "河馬獸",
  "451": "鉗尾蠍",
  "452": "龍王蠍",
  "453": "不良蛙",
  "454": "毒骷蛙",
  "455": "尖牙籠",
  "456": "螢光魚",
  "457": "霓虹魚",
  "458": "小球飛魚",
  "459": "雪笠怪",
  "460": "暴雪王",
  "461": "瑪狃拉",
  "462": "自爆磁怪",
  "463": "大舌舔",
  "464": "超甲狂犀",
  "465": "巨蔓藤",
  "466": "電擊魔獸",
  "467": "鴨嘴炎獸",
  "468": "波克基斯",
  "469": "遠古巨蜓",
  "470": "葉伊布",
  "471": "冰伊布",
  "472": "天蠍王",
  "473": "象牙豬",
  "474": "多邊獸Ｚ",
  "475": "艾路雷朵",
  "476": "大朝北鼻",
  "477": "黑夜魔靈",
  "478": "雪妖女",
  "479": "洛托姆",
  "480": "由克希",
  "481": "艾姆利多",
  "482": "亞克諾姆",
  "483": "帝牙盧卡",
  "484": "帕路奇亞",
  "485": "席多藍恩",
  "486": "雷吉奇卡斯",
  "487": "騎拉帝納",
  "488": "克雷色利亞",
  "489": "霏歐納",
  "490": "瑪納霏",
  "491": "達克萊伊",
  "492": "謝米",
  "493": "阿爾宙斯",
  "494": "比克提尼",
  "495": "藤藤蛇",
  "496": "青藤蛇",
  "497": "君主蛇",
  "498": "暖暖豬",
  "499": "炒炒豬",
  "500": "炎武王",
  "501": "水水獺",
  "502": "雙刃丸",
  "503": "大劍鬼",
  "504": "探探鼠",
  "505": "步哨鼠",
  "506": "小約克",
  "507": "哈約克",
  "508": "長毛狗",
  "509": "扒手貓",
  "510": "酷豹",
  "511": "花椰猴",
  "512": "花椰猿",
  "513": "爆香猴",
  "514": "爆香猿",
  "515": "冷水猴",
  "516": "冷水猿",
  "517": "食夢夢",
  "518": "夢夢蝕",
  "519": "豆豆鴿",
  "520": "咕咕鴿",
  "521": "高傲雉雞",
  "522": "斑斑馬",
  "523": "雷電斑馬",
  "524": "石丸子",
  "525": "地幔岩",
  "526": "龐岩怪",
  "527": "滾滾蝙蝠",
  "528": "心蝙蝠",
  "529": "螺釘地鼠",
  "530": "龍頭地鼠",
  "531": "差不多娃娃",
  "532": "搬運小匠",
  "533": "鐵骨土人",
  "534": "修建老匠",
  "535": "圓蝌蚪",
  "536": "藍蟾蜍",
  "537": "蟾蜍王",
  "538": "投摔鬼",
  "539": "打擊鬼",
  "540": "蟲寶包",
  "541": "寶包繭",
  "542": "保母蟲",
  "543": "百足蜈蚣",
  "544": "車輪毬",
  "545": "蜈蚣王",
  "546": "木棉球",
  "547": "風妖精",
  "548": "百合根娃娃",
  "549": "裙兒小姐",
  "550": "野蠻鱸魚",
  "551": "黑眼鱷",
  "552": "混混鱷",
  "553": "流氓鱷",
  "554": "火紅不倒翁",
  "555": "達摩狒狒",
  "556": "沙鈴仙人掌",
  "557": "石居蟹",
  "558": "岩殿居蟹",
  "559": "滑滑小子",
  "560": "頭巾混混",
  "561": "象徵鳥",
  "562": "哭哭面具",
  "563": "死神棺",
  "564": "原蓋海龜",
  "565": "肋骨海龜",
  "566": "始祖小鳥",
  "567": "始祖大鳥",
  "568": "破破袋",
  "569": "灰塵山",
  "570": "索羅亞",
  "571": "索羅亞克",
  "572": "泡沫栗鼠",
  "573": "奇諾栗鼠",
  "574": "哥德寶寶",
  "575": "哥德小童",
  "576": "哥德小姐",
  "577": "單卵細胞球",
  "578": "雙卵細胞球",
  "579": "人造細胞卵",
  "580": "鴨寶寶",
  "581": "舞天鵝",
  "582": "迷你冰",
  "583": "多多冰",
  "584": "雙倍多多冰",
  "585": "四季鹿",
  "586": "萌芽鹿",
  "587": "電飛鼠",
  "588": "蓋蓋蟲",
  "589": "騎士蝸牛",
  "590": "哎呀球菇",
  "591": "敗露球菇",
  "592": "輕飄飄",
  "593": "胖嘟嘟",
  "594": "保母曼波",
  "595": "電電蟲",
  "596": "電蜘蛛",
  "597": "種子鐵球",
  "598": "堅果啞鈴",
  "599": "齒輪兒",
  "600": "齒輪組",
  "601": "齒輪怪",
  "602": "麻麻小魚",
  "603": "麻麻鰻",
  "604": "麻麻鰻魚王",
  "605": "小灰怪",
  "606": "大宇怪",
  "607": "燭光靈",
  "608": "燈火幽靈",
  "609": "水晶燈火靈",
  "610": "牙牙",
  "611": "斧牙龍",
  "612": "雙斧戰龍",
  "613": "噴嚏熊",
  "614": "凍原熊",
  "615": "幾何雪花",
  "616": "小嘴蝸",
  "617": "敏捷蟲",
  "618": "泥巴魚",
  "619": "功夫鼬",
  "620": "師父鼬",
  "621": "赤面龍",
  "622": "泥偶小人",
  "623": "泥偶巨人",
  "624": "駒刀小兵",
  "625": "劈斬司令",
  "626": "爆炸頭水牛",
  "627": "毛頭小鷹",
  "628": "勇士雄鷹",
  "629": "禿鷹丫頭",
  "630": "禿鷹娜",
  "631": "熔蟻獸",
  "632": "鐵蟻",
  "633": "單首龍",
  "634": "雙首暴龍",
  "635": "三首惡龍",
  "636": "燃燒蟲",
  "637": "火神蛾",
  "638": "勾帕路翁",
  "639": "代拉基翁",
  "640": "畢力吉翁",
  "641": "龍捲雲",
  "642": "雷電雲",
  "643": "萊希拉姆",
  "644": "捷克羅姆",
  "645": "土地雲",
  "646": "酋雷姆",
  "647": "凱路迪歐",
  "648": "美洛耶塔",
  "649": "蓋諾賽克特",
  "808": "美錄坦",
  "809": "美錄梅塔",
}

})();
